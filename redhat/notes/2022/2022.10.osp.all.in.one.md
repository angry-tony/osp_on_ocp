# openstack 17.0 all in one

https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/17.0/html-single/standalone_deployment_guide/index

# install a rhel 9.0 vm

```bash

osinfo-query os | grep rhel9
#  rhel9.0              | Red Hat Enterprise Linux 9.0                       | 9.0      | http://redhat.com/rhel/9.0

create_lv() {
    var_vg=$1
    var_pool=$2
    var_lv=$3
    var_size=$4
    var_action=$5
    lvremove -f $var_vg/$var_lv
    # lvcreate -y -L $var_size -n $var_lv $var_vg
    if [ "$var_action" == "recreate" ]; then
      lvcreate --type thin -n $var_lv -V $var_size --thinpool $var_vg/$var_pool
      wipefs --all --force /dev/$var_vg/$var_lv
    fi
}

virsh destroy osp-17-0-all-in-one
virsh undefine osp-17-0-all-in-one

create_lv vgdata poolA lv-osp-17-0-all-in-one 200G recreate

SNO_MEM=64

virt-install --name=osp-17-0-all-in-one --vcpus=16 --ram=$(($SNO_MEM*1024)) \
  --cpu=host-model \
  --disk path=/dev/vgdata/lv-osp-17-0-all-in-one,device=disk,bus=virtio,format=raw \
  --os-variant rhel9.0 \
  --network bridge=baremetal,model=virtio \
  --network bridge=baremetal,model=virtio \
  --graphics vnc,port=59101 \
  --initrd-inject /data/kvm/osp-ks.cfg --extra-args "inst.ks=file:/osp-ks.cfg" \
  --boot menu=on --location /data/kvm/rhel.9.0.iso

```

# basic setup for osp17

```bash
sshpass -p redhat ssh-copy-id root@172.21.6.21

ssh -tt -D 8801 -R 18801:10.147.17.89:5085 root@172.21.6.21

export PROXY="http://127.0.0.1:18801"

subscription-manager register --proxy=$PROXY --auto-attach --username ********* --password ********

useradd stack

echo redhat | passwd --stdin stack

echo "stack ALL=(root) NOPASSWD:ALL" | tee -a /etc/sudoers.d/stack
chmod 0440 /etc/sudoers.d/stack

subscription-manager release --set=9.0

dnf install -y dnf-utils tmux

# subscription-manager repos --proxy=$PROXY --disable=*

subscription-manager repos --proxy=$PROXY \
  --enable=rhel-9-for-x86_64-baseos-eus-rpms \
  --enable=rhel-9-for-x86_64-appstream-eus-rpms \
  --enable=rhel-9-for-x86_64-highavailability-eus-rpms \
  --enable=openstack-17-for-rhel-9-x86_64-rpms \
  --enable=fast-datapath-for-rhel-9-x86_64-rpms

dnf update -y

reboot

dnf install -y python3-tripleoclient

```

# install all in one osp

```bash
su - stack

openstack tripleo container image prepare default --local-push-destination --output-env-file $HOME/containers-prepare-parameters.yaml
# parameter_defaults:
#   ContainerImagePrepare:
#   - set:
#       ceph_alertmanager_image: ose-prometheus-alertmanager
#       ceph_alertmanager_namespace: registry.redhat.io/openshift4
#       ceph_alertmanager_tag: 4.6
#       ceph_grafana_image: rhceph-5-dashboard-rhel8
#       ceph_grafana_namespace: registry.redhat.io/rhceph
#       ceph_grafana_tag: latest
#       ceph_image: rhceph-5-rhel8
#       ceph_namespace: registry.redhat.io/rhceph
#       ceph_node_exporter_image: ose-prometheus-node-exporter
#       ceph_node_exporter_namespace: registry.redhat.io/openshift4
#       ceph_node_exporter_tag: v4.6
#       ceph_prometheus_image: ose-prometheus
#       ceph_prometheus_namespace: registry.redhat.io/openshift4
#       ceph_prometheus_tag: 4.6
#       ceph_tag: latest
#       name_prefix: openstack-
#       name_suffix: ''
#       namespace: registry.redhat.io/rhosp-rhel9
#       neutron_driver: ovn
#       rhel_containers: false
#       tag: '17.0'
#     tag_from_label: '{version}-{release}'

# export REGISTRY_USER_NAME=''
# export REGISTRY_TOKEN=''

# cat >> $HOME/containers-prepare-parameters.yaml << EOF
#   ContainerImageRegistryCredentials:
#     registry.redhat.io:
#       $REGISTRY_USER_NAME: "$REGISTRY_TOKEN"
#   ContainerImageRegistryLogin: true
# EOF

ssh-keygen

export IP=192.168.25.2
export VIP=192.168.25.3
export NETMASK=24
export INTERFACE=enp2s0
export DNS1=172.21.1.1
export DNS2=114.114.114.114
export GATEWAY=172.21.6.254

cat << EOF > $HOME/standalone_parameters.yaml
parameter_defaults:
  CloudName: $IP
  CloudDomain: localdomain
  ControlPlaneStaticRoutes: []
  Debug: true
  DeploymentUser: $USER
  KernelIpNonLocalBind: 1
  DockerInsecureRegistryAddress:
    - $IP:8787
  NeutronPublicInterface: $INTERFACE
  NeutronDnsDomain: localdomain
  NeutronBridgeMappings: datacentre:br-ctlplane
  NeutronPhysicalBridge: br-ctlplane
  StandaloneEnableRoutedNetworks: false
  StandaloneHomeDir: $HOME
  StandaloneLocalMtu: 1500
  NovaComputeLibvirtType: qemu
  OctaviaAmphoraSshKeyFile: "/home/stack/.ssh/id_rsa.pub"
EOF

  # ControlPlaneStaticRoutes:
  #   - ip_netmask: 0.0.0.0/0
  #     next_hop: $GATEWAY
  #     default: true

# parameter_defaults:
#   NtpServer:
#     - clock.example.com

sudo podman login registry.redhat.io

sudo hostnamectl set-hostname all-in-one.example.net
sudo hostnamectl set-hostname all-in-one.example.net --transient

sudo openstack tripleo deploy \
  --templates \
  --local-ip=$IP/$NETMASK \
  --control-virtual-ip=$VIP \
  -e /usr/share/openstack-tripleo-heat-templates/environments/standalone/standalone-tripleo.yaml \
  -r /usr/share/openstack-tripleo-heat-templates/roles/Standalone.yaml \
  -e $HOME/containers-prepare-parameters.yaml \
  -e $HOME/standalone_parameters.yaml \
  --output-dir $HOME \
  --standalone


```