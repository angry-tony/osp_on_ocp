# create ipvlan based on bridge

有客户问，k8s上能不能配置一个ipvlan，这个ipvlan的master是一个bridge。这个问题看上去是问k8s cni, nmstat的，其实是问操作系统上的能力的。因为操作系统上能配置出来，那么cni/nmstat都是封装这个能力给k8s使用而已。那么我们就来看看操作系统上，能不能配置出来。

参考资料：
- [配置和管理网络 第 6 章 配置网络桥接](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html/configuring_and_managing_networking/configuring-a-network-bridge_configuring-and-managing-networking)
- [使用 iproute2 创建和配置 IPVLAN 设备](https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/8/html/configuring_and_managing_networking/creating-and-configuring-the-ipvlan-device-using-iproute2_getting-started-with-ipvlan)

```bash

nmcli connection add type bridge con-name bridge0 ifname bridge0

nmcli connection add type ethernet slave-type bridge con-name bridge0-port1 ifname ens224 master bridge0
nmcli connection add type ethernet slave-type bridge con-name bridge0-port2 ifname ens256 master bridge0

nmcli connection modify bridge0 ipv4.addresses '192.0.2.1/24'
nmcli connection modify bridge0 ipv4.gateway '192.0.2.254'
nmcli connection modify bridge0 ipv4.dns '192.0.2.253'
nmcli connection modify bridge0 ipv4.dns-search 'example.com'
nmcli connection modify bridge0 ipv4.method manual

nmcli connection up bridge0

ip link add link bridge0 name my_ipvlan type ipvlan mode l2

ip link
# 1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
# 2: ens160: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000
#     link/ether 00:0c:29:71:ff:9e brd ff:ff:ff:ff:ff:ff
# 3: ens224: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq master bridge0 state UP mode DEFAULT group default qlen 1000
#     link/ether 00:0c:29:71:ff:a8 brd ff:ff:ff:ff:ff:ff
# 4: ens256: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq master bridge0 state UP mode DEFAULT group default qlen 1000
#     link/ether 00:0c:29:71:ff:b2 brd ff:ff:ff:ff:ff:ff
# 5: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default
#     link/ether 02:42:c3:09:b6:44 brd ff:ff:ff:ff:ff:ff
# 6: bridge0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default qlen 1000
#     link/ether 00:0c:29:71:ff:a8 brd ff:ff:ff:ff:ff:ff
# 7: my_ipvlan@bridge0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
#     link/ether 00:0c:29:71:ff:a8 brd ff:ff:ff:ff:ff:ff

nmcli con
# NAME           UUID                                  TYPE      DEVICE
# ens160         05ec1ceb-b350-404b-bdab-53834cc91669  ethernet  ens160
# bridge0        0e10434c-11b0-4d2e-8efb-6d83f86024f2  bridge    bridge0
# docker0        75729fee-42fc-4db3-8550-97a0aefccadf  bridge    docker0
# bridge0-port1  1e0f9ff4-9bc1-48af-bc06-eefe9ed0d418  ethernet  ens224
# bridge0-port2  a7450478-26d6-4284-bc8b-8e40ae22baae  ethernet  ens256


```