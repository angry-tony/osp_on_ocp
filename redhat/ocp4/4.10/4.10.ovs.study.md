# openshift 4 OVN

bugs:
- if default gateway for openshift 4 is off-line, then ovn will be trouble, the service kubelet can't be accessed by ingress pod, then ingress will not start up.

reference:
- [Openshift Networking  + OVN-Kubernetes](https://docs.google.com/presentation/d/1ZtwP3t6uNAU0g4S7IbqSxPg2bmQW-pPGyMW2ZNj9Nrg/edit#slide=id.p)
- https://github.com/openshift/ovn-kubernetes

```bash

oc get pod -A | grep ovn
# openshift-ovn-kubernetes                           ovnkube-master-q7xsb                                         6/6     Running            144              4d21h
# openshift-ovn-kubernetes                           ovnkube-node-w2qs2                                           5/5     Running            122              4d21h

oc rsh -n openshift-ovn-kubernetes  -c ovnkube-master  ovnkube-master-q7xsb  

ovn-sbctl dump-flows | grep 172.30.0.1
#   table=5 (lr_in_defrag       ), priority=110  , match=(ip && ip4.dst == 172.30.0.1 && tcp), action=(reg0 = 172.30.0.1; reg9[16..31] = tcp.dst; ct_dnat;)
#   table=5 (lr_in_defrag       ), priority=110  , match=(ip && ip4.dst == 172.30.0.10 && tcp), action=(reg0 = 172.30.0.10; reg9[16..31] = tcp.dst; ct_dnat;)
#   table=5 (lr_in_defrag       ), priority=110  , match=(ip && ip4.dst == 172.30.0.10 && udp), action=(reg0 = 172.30.0.10; reg9[16..31] = udp.dst; ct_dnat;)
#   table=6 (lr_in_dnat         ), priority=120  , match=(ct.est && ip4 && reg0 == 172.30.0.1 && tcp && reg9[16..31] == 443 && ct_label.natted == 1), action=(flags.force_snat_for_lb = 1; next;)
#   table=6 (lr_in_dnat         ), priority=120  , match=(ct.est && ip4 && reg0 == 172.30.0.10 && tcp && reg9[16..31] == 53 && ct_label.natted == 1), action=(flags.force_snat_for_lb = 1; next;)
#   table=6 (lr_in_dnat         ), priority=120  , match=(ct.est && ip4 && reg0 == 172.30.0.10 && tcp && reg9[16..31] == 9154 && ct_label.natted == 1), action=(flags.force_snat_for_lb = 1; next;)
#   table=6 (lr_in_dnat         ), priority=120  , match=(ct.est && ip4 && reg0 == 172.30.0.10 && udp && reg9[16..31] == 53 && ct_label.natted == 1), action=(flags.force_snat_for_lb = 1; next;)
#   table=6 (lr_in_dnat         ), priority=120  , match=(ct.new && ip4 && reg0 == 172.30.0.1 && tcp && reg9[16..31] == 443), action=(flags.force_snat_for_lb = 1; ct_lb(backends=169.254.169.2:6443);)
#   table=6 (lr_in_dnat         ), priority=120  , match=(ct.new && ip4 && reg0 == 172.30.0.10 && tcp && reg9[16..31] == 53), action=(flags.force_snat_for_lb = 1; ct_lb(backends=10.128.0.35:5353);)
#   table=6 (lr_in_dnat         ), priority=120  , match=(ct.new && ip4 && reg0 == 172.30.0.10 && tcp && reg9[16..31] == 9154), action=(flags.force_snat_for_lb = 1; ct_lb(backends=10.128.0.35:9154);)
#   table=6 (lr_in_dnat         ), priority=120  , match=(ct.new && ip4 && reg0 == 172.30.0.10 && udp && reg9[16..31] == 53), action=(flags.force_snat_for_lb = 1; ct_lb(backends=10.128.0.35:5353);)
#   table=12(ls_in_lb           ), priority=120  , match=(ct.new && ip4.dst == 172.30.0.1 && tcp.dst == 443), action=(reg0[1] = 0; reg1 = 172.30.0.1; reg2[0..15] = 443; ct_lb(backends=192.168.7.13:6443);)
#   table=12(ls_in_lb           ), priority=120  , match=(ct.new && ip4.dst == 172.30.0.10 && tcp.dst == 53), action=(reg0[1] = 0; reg1 = 172.30.0.10; reg2[0..15] = 53; ct_lb(backends=10.128.0.35:5353);)
#   table=12(ls_in_lb           ), priority=120  , match=(ct.new && ip4.dst == 172.30.0.10 && tcp.dst == 9154), action=(reg0[1] = 0; reg1 = 172.30.0.10; reg2[0..15] = 9154; ct_lb(backends=10.128.0.35:9154);)
#   table=12(ls_in_lb           ), priority=120  , match=(ct.new && ip4.dst == 172.30.0.10 && udp.dst == 53), action=(reg0[1] = 0; reg1 = 172.30.0.10; reg2[0..15] = 53; ct_lb(backends=10.128.0.35:5353);)

ip tc | grep 172.30.0.1
# 172.30.0.10 age 26.713sec cwnd 10 rtt 1254us rttvar 796us source 192.168.7.13
# 172.30.0.1 age 465.883sec source 192.168.7.13

tc qdisc show
# qdisc noqueue 0: dev lo root refcnt 2
# qdisc fq_codel 0: dev enp1s0 root refcnt 2 limit 10240p flows 1024 quantum 1514 target 5ms interval 100ms memory_limit 32Mb ecn drop_batch 64
# qdisc noqueue 0: dev ovn-k8s-mp0 root refcnt 2
# qdisc noqueue 0: dev br-ex root refcnt 2
# qdisc noqueue 0: dev ccf42bff33cfe8a root refcnt 2
# qdisc noqueue 0: dev 9120b293337f4af root refcnt 2
# ....

ovs-dpctl dump-flows  | grep 172.30.0.1
# ......
# recirc_id(0),in_port(51),ct_state(-new-est-trk),ct_label(0/0x2),eth(src=0a:58:0a:80:00:22,dst=0a:58:0a:80:00:01),eth_type(0x0800),ipv4(src=10.128.0.34,dst=172.30.0.1,proto=6,frag=no),tcp(dst=443), packets:26646, bytes:2406083, used:0.329s, flags:SFPR., actions:ct(zone=53,nat),recirc(0xb9)
# recirc_id(0),in_port(55),ct_state(-new-est-trk),ct_label(0/0x2),eth(src=0a:58:0a:80:00:61,dst=0a:58:0a:80:00:01),eth_type(0x0800),ipv4(src=10.128.0.97,dst=172.30.0.1,proto=6,frag=no),tcp(dst=443), packets:5, bytes:704, used:3.170s, flags:P., actions:ct(zone=60,nat),recirc(0x3755c)
# recirc_id(0),in_port(44),ct_state(-new-est-trk),ct_label(0/0x2),eth(src=0a:58:0a:80:00:0f,dst=0a:58:0a:80:00:01),eth_type(0x0800),ipv4(src=10.128.0.15,dst=172.30.0.10,proto=17,frag=no),udp(src=32768/0x8000,dst=53), packets:6, bytes:688, used:0.975s, actions:ct(zone=45,nat),recirc(0x3762b)
# recirc_id(0),in_port(22),ct_state(-new-est-trk),ct_label(0/0x2),eth(src=0a:58:0a:80:00:10,dst=0a:58:0a:80:00:01),eth_type(0x0800),ipv4(src=10.128.0.16,dst=172.30.0.1,proto=6,frag=no),tcp(dst=443), packets:16539, bytes:1761983, used:0.315s, flags:SFPR., actions:ct(zone=27,nat),recirc(0x15a)
# recirc_id(0),in_port(60),ct_state(-new-est-trk),ct_label(0/0x2),eth(src=0a:58:0a:80:00:0a,dst=0a:58:0a:80:00:01),eth_type(0x0800),ipv4(src=10.128.0.10,dst=172.30.0.1,proto=6,frag=no),tcp(dst=443), packets:5329, bytes:531316, used:1.442s, flags:P., actions:ct(zone=54,nat),recirc(0xed)
# recirc_id(0),in_port(28),ct_state(-new-est-trk),ct_label(0/0x2),eth(src=0a:58:0a:80:00:30,dst=0a:58:0a:80:00:01),eth_type(0x0800),ipv4(src=10.128.0.48,dst=172.30.0.1,proto=6,frag=no),tcp(dst=443), packets:103173, bytes:20740493, used:0.003s, flags:SP., actions:ct(zone=32,nat),recirc(0x1b0)
# recirc_id(0),in_port(13),ct_state(-new-est-trk),ct_label(0/0x2),eth(src=0a:58:0a:80:00:40,dst=0a:58:0a:80:00:01),eth_type(0x0800),ipv4(src=10.128.0.64,dst=172.30.0.1,proto=6,frag=no),tcp(dst=443), packets:0, bytes:0, used:never, actions:ct(zone=15,nat),recirc(0x3758c)
# recirc_id(0),in_port(35),ct_state(-new-est-trk),ct_label(0/0x2),eth(src=0a:58:0a:80:00:20,dst=0a:58:0a:80:00:01),eth_type(0x0800),ipv4(src=10.128.0.32,dst=172.30.0.1,proto=6,frag=no),tcp(dst=443), packets:47, bytes:4946, used:1.101s, flags:P., actions:ct(zone=51,nat),recirc(0x371aa)
# recirc_id(0),in_port(46),ct_state(-new-est-trk),ct_label(0/0x2),eth(src=0a:58:0a:80:00:4f,dst=0a:58:0a:80:00:01),eth_type(0x0800),ipv4(src=10.128.0.79,dst=172.30.0.1,proto=6,frag=no),tcp(dst=443), packets:123, bytes:23682, used:0.002s, flags:P., actions:ct(zone=59,nat),recirc(0x36a05)
# recirc_id(0),in_port(10),ct_state(-new-est-trk),ct_label(0/0x2),eth(src=0a:58:0a:80:00:3b,dst=0a:58:0a:80:00:01),eth_type(0x0800),ipv4(src=10.128.0.59,dst=172.30.0.1,proto=6,frag=no),tcp(dst=443), packets:29975, bytes:6133782, used:0.563s, flags:P., actions:ct(zone=19,nat),recirc(0x4d)

```