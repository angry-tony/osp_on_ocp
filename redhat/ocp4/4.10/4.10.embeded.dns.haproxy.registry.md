# openshift4 内置 dns, haproxy, image registry

openshift4 虽然号称支持单节点，3节点的边缘部署模式，但是实际项目实施的时候，往往需要多一个节点，这个节点需要承载的任务有：
- DNS服务 : 因为k8s的各种内部服务，都依赖DNS解析
- load balancer 服务 : 3 k8s master是需要负载均衡服务的。
- 镜像仓库 : 这个是因为crio会在系统重启的时候，检查是否是意外重启，如果是，会清空本机镜像缓存，重新从镜像仓库下载。

上述服务，当然可以集中部署到核心区域，但是有些场景，比如私有5G核心网，我们必须把上述服务部署到边缘站点中。

我们还知道，openshift4 本身就是基于 rhcos / coreos 操作系统之上的 k8s， 我们自然希望可以把上述的服务，内嵌到 rhcos / coreos 里面去，实现真正意义上的 单节点/3节点 的部署模式。

以下是架构设计：

![](./dia/4.10.embed.dns.haproxy.registry.drawio.svg)

如果没有这个架构，那么我们的部署会是这个样子的，可以看到，必须要有一个 helper 节点，提供辅助功能。

![](./dia/4.10.embed.dns.registry.orig.drawio.svg)

让我们开始吧。

# notes

```bash

yum install -y pdns pdns-recursor

mv /etc/pdns/pdns.conf /etc/pdns/pdns.conf.bak

cat << EOF > /etc/pdns/pdns.conf
launch=bind
local-port=5301
setgid=pdns
setuid=pdns
bind-config=/etc/pdns/bind.conf
bind-check-interval=300
EOF

cat << EOF > /etc/pdns/bind.conf
zone "inside-out.xyz" { type master; file "/etc/pdns/inside-out.xyz"; };
EOF

cat << 'EOF' > /etc/pdns/inside-out.xyz
$TTL 180 
@ IN SOA ns1.inside-out.xyz. postmaster.inside-out.xyz. (
        2014080704 ; Serial Number (date YYYYMMDD++) 
        86400 ; Refresh (24 hours) 
        1800 ; Retry (1/2 hour) 
        3600000 ; Expire (42 days) 
        21600) ; Minimum (6 hours) 
        IN NS ns1.inside-out.xyz.
        IN NS ns2.inside-out.xyz.
@       IN A 192.168.0.1
        IN MX 10 mail.inside-out.xyz.
        IN MX 12 mail2.inside-out.xyz.
        IN TXT "v=spf1 a mx ~all" 
www     IN CNAME inside-out.xyz. 
mail    IN CNAME mail.okay.com.mx. 
ns1     IN A 8.8.8.8 
ns2     IN A 8.8.4.4
host1   IN A 192.168.7.1
host2   IN A 192.168.7.2
EOF

# ausearch -c 'pdns_server' --raw | audit2allow -M my-pdnsserver
# semodule -X 300 -i my-pdnsserver.pp

semanage port -a -t dns_port_t -p udp 5301
semanage port -a -t dns_port_t -p tcp 5301

systemctl enable --now pdns

```

# end